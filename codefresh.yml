version: '1.0'

steps:
  build-prj:
    type: build
    description: UC - build step
    image-name: codefreshio/yaml-example
    dockerfile: Dockerfile
    tag: ${{CF_BRANCH}}
    when:
      - condition: "'${{CF_BRANCH}}' == 'condition-step' && ('${{CF_BRANCH}}' != '123')"
      - condition: "-5"

  freestyle-step:
    image: node:latest
    working-directory : ${{initial-clone}}
    commands:
        - npm -v
    when:
      - condition: "'${{CF_BRANCH}}' == 'condition-step'"
      - name: "Branch is test_me1"
        condition: "'${{CF_BRANCH}}' == 'condition-step'"
      - name: "Verify CONDITION is in branch name"
        condition: "match('${{CF_BRANCH}}', 'CONDITION', false)"

  composition-step:
      description: Attempting to run as part of composition.
      type: composition
      composition:
        version: '2'
        services:
          app:
            image: 'advance512demo/demochat:master'
            ports:
              - 5000
            depends_on:
              - mongo
          mongo:
            image: mongo
      composition-candidates:
        main:
          image: nhoag/curl
          command: bash -c "sleep 20 && curl http://app:5000/" | echo 'works'
      when:
        - name: "Verify CONDITION is in branch name"
          condition: "match('${{CF_BRANCH}}', 'CONDITION', false)"

  push-step:
        description: Pushing image to Docker hub.
        type: push
        candidate: ${{build-step}}
        tag: ${{CF_BRANCH}}
        fail-fast: false
        when:
          - name: "123"
            condition: "'${{CF_BRANCH}}' == 'master'"

  launch-compose:
    type: launch-composition
    when:
      - name: "launch-compose"
        condition: "match('${{CF_BRANCH}}', 'condition-step', false)"
      - name: "launch-compose"
        condition: "'${{CF_BRANCH}}' == 'condition-step'"
    composition:
        version: '2'
        services:
          app:
            image: ${{build-prj}}
            ports:
              - 3000
