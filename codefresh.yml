version: '1.0'
steps:
    build_step:
      type: build
      image_name: codefreshio/yaml-example
      dockerfile: Dockerfile
      tag: ${{CF_BRANCH}}

    check_env_file:
      image: node:latest
      working_directory: ${{initial-clone}}
      commands:
        - pwd
        - ls .

    check_env_file_:
      type: composition
      working_directory: ${{initial-clone}}
      composition:
        version: '2'
        services:
          db:
            image: mysql:latest
            ports:
              - 3306
            environment:
              MYSQL_ROOT_PASSWORD: admin
              MYSQL_USER: my_user
              MYSQL_PASSWORD: admin
              MYSQL_DATABASE: nodejs
      composition_candidates:
          test:
            image: ${{build_step}}
            command: bash -c 'echo test:$MYSQL_ROOT_PASSWORD'
            env_file: /usr/src/app/mysql.env


#    unit_test:
#      type: composition
#      working_directory: ${{initial-clone}}
#      composition:
#          version: '2'
#          services:
#            db:
#              image: mysql:latest
#              ports:
#                - 3306
#              env_file: /codefresh/volume/cf-yml-examples/mysql.env
#
##              environment:
##                MYSQL_ROOT_PASSWORD: admin
##                MYSQL_USER: my_user
##                MYSQL_PASSWORD: admin
##                MYSQL_DATABASE: nodejs
#      composition_candidates:
#          test:
#            image: ${{build-step}}
#            command: bash -c 'sleep 30 && MYSQL_ROOT_PASSWORD=admin MYSQL_USER=my_user MYSQL_HOST=db MYSQL_PASSWORD=admin MYSQL_DATABASE=nodejs npm test'